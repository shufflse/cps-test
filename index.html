<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CPS Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/2.11.5/css/OverlayScrollbars.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/2.11.5/browser/overlayscrollbars.browser.es6.min.js"></script>
</head>
<body>
  <section class="section">
    <div class="card">

      <div class="card-header">
        <h4 class="title"><span id="timeText"></span> Second CPS Test</h4>
        <button id="themeToggle" class="theme-btn" aria-label="Toggle theme">
          <span id="themeIcon">🌙</span>
        </button>
      </div>

      <div class="message">
        <input class="input" type="number" id="timeTxt" placeholder="Duration (seconds)" />
        <div class="stats">
          Timer: <span id="timer">0</span><br>
          Score: <span id="score">0</span><br>
          Clicks/s: <span id="clicks">0</span>
        </div>
      </div>

      <div id="clickarea" role="button" tabindex="0">
        <span id="clickLabel">Click Here</span>
      </div>

      <div style="margin-top: 0.75rem;">
        <button id="stop" class="button is-warning" style="height: 50px;">Stop</button>
      </div>
      
    </div>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/prism.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.9.1/js/OverlayScrollbars.min.js"></script>

  <script>
    (function () {
      let score = 0;
      let started = false;
      let startTime = 0;
      let timerId = null;
      let gameEnded = false;
      let lockClicks = false;

      const input = document.getElementById("timeTxt");
      const timerTxt = document.getElementById("timer");
      const scoreTxt = document.getElementById("score");
      const clicksTxt = document.getElementById("clicks");
      const timeText = document.getElementById("timeText");
      const stopBtn = document.getElementById("stop");
      const clickArea = document.getElementById("clickarea");
      const clickLabel = document.getElementById("clickLabel");

      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");

      const show = elem => { if (elem) elem.style.display = 'inline-block'; };
      const hide = elem => { if (elem) elem.style.display = 'none'; };

      const updateTimeText = () => {
        timeText.textContent = input.value || "";
      };

      const startGame = () => {
        const duration = parseFloat(input.value);
        if (isNaN(duration) || duration <= 0) {
          alert("Please enter a valid duration.");
          return false;
        }

        gameEnded = false;
        lockClicks = false;
        clickArea.style.pointerEvents = 'auto';
        clickArea.classList.remove('disabled');

        score = 0;
        started = true;
        startTime = performance.now();

        show(stopBtn);
        clickArea.classList.add('active');
        clickLabel.textContent = "Clicks: 0";

        timerTxt.textContent = '0.000';
        scoreTxt.textContent = '0';
        clicksTxt.textContent = '0.00';

        timerId = setInterval(() => {
          const elapsed = (performance.now() - startTime) / 1000;
          if (elapsed < duration) {
            timerTxt.textContent = elapsed.toFixed(3);
            const cps = elapsed > 0 ? (score / elapsed) : 0;
            clicksTxt.textContent = cps.toFixed(2);
          } else {
            clearInterval(timerId);
            started = false;
            endGame(duration);
          }
        }, 50);

        return true;
      };

      const endGame = (actualDuration) => {
        if (typeof actualDuration !== 'number') {
          actualDuration = (performance.now() - startTime) / 1000;
        }
        const cps = actualDuration > 0 ? (score / actualDuration) : 0;

        timerTxt.textContent = actualDuration.toFixed(3);
        clicksTxt.textContent = cps.toFixed(2);
        scoreTxt.textContent = score;

        hide(stopBtn);
        clickArea.classList.remove('active');
        clickLabel.textContent = 'Click Here';

        lockClicks = true;
        clickArea.style.pointerEvents = 'none';
        clickArea.classList.add('disabled');

        setTimeout(() => {
          alert(
            `Completed with ${score} clicks in ${actualDuration.toFixed(2)} seconds.\n` +
            `That's ${cps.toFixed(2)} clicks per second.`
          );
          lockClicks = false;
          gameEnded = false;
          clickArea.style.pointerEvents = 'auto';
          clickArea.classList.remove('disabled');
        }, 80);
      };

      const stopGame = () => {
        if (!started) return;
        clearInterval(timerId);
        started = false;
        const elapsed = (performance.now() - startTime) / 1000;
        endGame(elapsed);
      };

      clickArea.addEventListener("click", (e) => {
        if (lockClicks) return;
        if (gameEnded || !started) {
          const ok = startGame();
          if (!ok) return;

          score++;
          scoreTxt.textContent = score;
          const elapsed = (performance.now() - startTime) / 1000;
          clicksTxt.textContent = ((score) / (elapsed || 1)).toFixed(2);
          clickLabel.textContent = `Clicks: ${score}`;
          return;
        }

        score++;
        scoreTxt.textContent = score;
        clickLabel.textContent = `Clicks: ${score}`;
      });

      stopBtn.addEventListener("click", stopGame);

      document.addEventListener("DOMContentLoaded", () => {
        OverlayScrollbars(document.querySelectorAll("body"), {});
        hide(stopBtn);
        updateTimeText();

        themeIcon.textContent = document.body.classList.contains('dark-theme') ? '☀️' : '🌙';
      });

      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark-theme");
        themeIcon.textContent = document.body.classList.contains('dark-theme') ? '☀️' : '🌙';
      });

      input.addEventListener("input", updateTimeText);
    })();
  </script>
</body>
</html>

